---
- name: Gitea Setup | Install and enable Podman
  ansible.builtin.dnf:
    name:
      - podman
    state: present
  become: true

- name: Gitea Setup | Check if firewalld is running
  ansible.builtin.service_facts:
  become: true

- name: Gitea Setup | Configure firewalld if running
  block:
    - name: Gitea Setup | Ensure firewalld is configured to accept traffic
      ansible.posix.firewalld:
        port: "{{ item }}"
        state: enabled
        permanent: true
      loop:
        - "{{ gitea_ssh_port | default(2222, true) }}/tcp"
        - "{{ gitea_web_port | default(3000, true) }}/tcp"

    - name: Gitea Setup | Ensure firewalld is started
      ansible.builtin.service:
        name: firewalld
        state: restarted
        enabled: true
  when: ansible_facts.services["firewalld.service"] is defined
  become: true

- name: Gitea Setup | Ensure gitea registry configuration is in place
  ansible.builtin.template:
    src: gitea.conf.j2
    dest: /etc/containers/registries.conf.d/gitea.conf
    mode: 0755
  become: true

- name: Gitea Setup | Enable ssh-rsa for localhost
  ansible.builtin.blockinfile:
    block: |
      Host localhost
        HostkeyAlgorithms +ssh-rsa
        PubkeyAcceptedKeyTypes +ssh-rsa
    dest: ~/.ssh/config
    state: present
